---
title: "从hammer到jewel的RGW升级实战-by秦牧羊"
date: "2017-03-24"
author: "admin"
tags: 
  - "planet"
---

  
![](images/update.gif)  

## 前言

本篇来自秦牧羊的一篇分享，讲述的是从hammer升级到jewel的过程，以及其中的一些故障的处理，是一篇非常详细的实战分享

## 初始状态

### pool状态

<table><tbody><tr><td class="code"><pre><span class="line">root@demo:/home/demouser# rados lspools</span><br><span class="line">rbd</span><br><span class="line"><span class="title">.cn.rgw.root</span></span><br><span class="line"><span class="title">.cn-zone1.rgw.root</span></span><br><span class="line"><span class="title">.cn-zone1.rgw.domain</span></span><br><span class="line"><span class="title">.cn-zone1.rgw.control</span></span><br><span class="line"><span class="title">.cn-zone1.rgw.gc</span></span><br><span class="line"><span class="title">.cn-zone1.rgw.buckets.index</span></span><br><span class="line"><span class="title">.cn-zone1.rgw.buckets.extra</span></span><br><span class="line"><span class="title">.cn-zone1.rgw.buckets</span></span><br><span class="line"><span class="title">.cn-zone1.log</span></span><br><span class="line"><span class="title">.cn-zone1.intent-log</span></span><br><span class="line"><span class="title">.cn-zone1.usage</span></span><br><span class="line"><span class="title">.cn-zone1.users</span></span><br><span class="line"><span class="title">.cn-zone1.users.email</span></span><br><span class="line"><span class="title">.cn-zone1.users.swift</span></span><br><span class="line"><span class="title">.cn-zone1.users.uid</span></span><br></pre></td></tr></tbody></table>

### ceph.conf配置

<table><tbody><tr><td class="code"><pre><span class="line">[client<span class="class">.radosgw</span><span class="class">.us-zone1</span>]</span><br><span class="line">     rgw dns name = s3<span class="class">.ceph</span><span class="class">.work</span></span><br><span class="line">     rgw frontends = fastcgi</span><br><span class="line">     host = ceph<span class="class">.work</span></span><br><span class="line">     rgw region = cn</span><br><span class="line">     rgw region root pool = <span class="class">.cn</span><span class="class">.rgw</span><span class="class">.root</span></span><br><span class="line">     rgw zone = us-zone1</span><br><span class="line">     rgw zone root pool = <span class="class">.cn-zone1</span><span class="class">.rgw</span><span class="class">.root</span></span><br><span class="line">     keyring = /etc/ceph/ceph<span class="class">.client</span><span class="class">.radosgw</span><span class="class">.keyring</span></span><br><span class="line">     rgw socket path = /home/ceph/var/run/ceph-client<span class="class">.radosgw</span><span class="class">.us-zone1</span><span class="class">.sock</span></span><br><span class="line">     log file = /home/ceph/log/radosgw<span class="class">.us-zone1</span><span class="class">.log</span></span><br><span class="line">     rgw print continue = false</span><br><span class="line">    rgw <span class="attribute">content</span> length compat = true</span><br></pre></td></tr></tbody></table>

### 元数据信息检查

<table><tbody><tr><td class="code"><pre><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># radosgw-admin metadata list user --name client.radosgw.us-zone1</span></span><br><span class="line">[</span><br><span class="line">    <span class="string">"en-user1"</span>,</span><br><span class="line">    <span class="string">"us-zone1"</span>,</span><br><span class="line">    <span class="string">"us-user1"</span>,</span><br><span class="line">    <span class="string">"cn-user1"</span>,</span><br><span class="line">    <span class="string">"en-zone1"</span>,</span><br><span class="line">    <span class="string">"cn-zone1"</span>,</span><br><span class="line">    <span class="string">"cn-user2"</span></span><br><span class="line"></span><br><span class="line">]</span><br><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># radosgw-admin metadata list bucket --name client.radosgw.us-zone1</span></span><br><span class="line">[</span><br><span class="line">    <span class="string">"cn-test1"</span>,</span><br><span class="line">    <span class="string">"us-test1"</span>,</span><br><span class="line">    <span class="string">"en-test1"</span>,</span><br><span class="line">    <span class="string">"cn-test2"</span></span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></tbody></table>

### 软件版本及集群状态

<table><tbody><tr><td class="code"><pre><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># ceph -v</span></span><br><span class="line">ceph version <span class="number">0</span>.<span class="number">94.5</span> (<span class="number">9764</span>da52395923e0b32908d83a9f7304401fee43)</span><br><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># ceph -s</span></span><br><span class="line">    cluster <span class="number">23</span>d6f3f9-0b86-<span class="number">432</span>c-bb18-<span class="number">1722</span>f73e93e<span class="number">0</span></span><br><span class="line">     health <span class="constant">HEALTH_OK</span></span><br><span class="line">     monmap <span class="symbol">e1:</span> <span class="number">1</span> mons at {ceph.work=<span class="number">10.63</span>.<span class="number">48.19</span><span class="symbol">:</span><span class="number">6789</span>/<span class="number">0</span>}</span><br><span class="line">            election epoch <span class="number">1</span>, quorum <span class="number">0</span> ceph.work</span><br><span class="line">     osdmap <span class="symbol">e43:</span> <span class="number">3</span> <span class="symbol">osds:</span> <span class="number">3</span> up, <span class="number">3</span> <span class="keyword">in</span></span><br><span class="line">      pgmap <span class="symbol">v907719:</span> <span class="number">544</span> pgs, <span class="number">16</span> pools, <span class="number">2217</span> kB data, <span class="number">242</span> objects</span><br><span class="line">            <span class="number">3119</span> <span class="constant">MB </span>used, <span class="number">88994</span> <span class="constant">MB </span>/ <span class="number">92114</span> <span class="constant">MB </span>avail</span><br><span class="line">                 <span class="number">544</span> active+clean</span><br></pre></td></tr></tbody></table>

## ceph升级到最新jewel

这里要提醒一点就是如果ceph版本低于0.94.7，直接升级到10.xx会出一些问题，因为低版本的osdmap的数据结构与高版本不兼容，所以先升级到最新的hammer

<table><tbody><tr><td class="code"><pre><span class="line">root@demo:/home/demouser<span class="comment"># vi /etc/apt/sources.list.d/ceph.list </span></span><br><span class="line">deb http://mirrors.163.com/ceph/debian-hammer/ jessie main <span class="comment">#使用163源更新到最新的hammer</span></span><br><span class="line"></span><br><span class="line">root@demo:/home/demouser<span class="comment"># apt-get update</span></span><br><span class="line"><span class="keyword">...</span></span><br><span class="line">Fetched <span class="number">18.7</span> kB <span class="keyword">in</span> 11s (<span class="number">1</span>,<span class="number">587</span> B/s)</span><br><span class="line">Reading package lists... Done</span><br><span class="line"></span><br><span class="line">root@demo:/home/demouser<span class="comment"># apt-cache policy ceph</span></span><br><span class="line">ceph:</span><br><span class="line">  Installed: <span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> <span class="comment">#当前已经安装的版本</span></span><br><span class="line">  Candidate: <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> <span class="comment">#预备安装的版本</span></span><br><span class="line">  Version table:</span><br><span class="line">     <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> <span class="number">0</span></span><br><span class="line">        <span class="number">500</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main amd64 Packages</span><br><span class="line"> *** <span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> <span class="number">0</span></span><br><span class="line">        <span class="number">100</span> /var/lib/dpkg/status</span><br><span class="line"></span><br><span class="line">root@demo:/home/demouser<span class="comment"># aptitude install ceph ceph-common ceph-deploy ceph-fs-common ceph-fuse ceph-mds libcephfs1 python-ceph python-cephfs  librados2 libradosstriper1 python-rados  radosgw radosgw-agent librbd1 python-rbd rbd-fuse radosgw radosgw-agent</span></span><br><span class="line">The following packages will be REMOVED:</span><br><span class="line">  daemon{u} mpt-status{u}</span><br><span class="line">The following packages will be upgraded:</span><br><span class="line">  ceph ceph-common ceph-deploy ceph-fs-common ceph-fuse ceph-mds ceph-test libcephfs1 librados2 libradosstriper1 librbd1 python-ceph python-cephfs python-rados python-rbd radosgw radosgw-agent rbd-fuse</span><br><span class="line">The following packages are RECOMMENDED but will NOT be installed:</span><br><span class="line">  btrfs-tools fuse</span><br><span class="line"><span class="number">18</span> packages upgraded, <span class="number">0</span> newly installed, <span class="number">2</span> to remove and <span class="number">185</span> not upgraded.</span><br><span class="line">Need to get <span class="number">75.3</span> MB of archives. After unpacking <span class="number">3</span>,<span class="number">588</span> kB will be used.</span><br><span class="line">Do you want to continue? [Y/n/?] y</span><br><span class="line">Get: <span class="number">1</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main libcephfs1 amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">2</span>,<span class="number">706</span> kB]</span><br><span class="line">Get: <span class="number">2</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main ceph-mds amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">8</span>,<span class="number">053</span> kB]</span><br><span class="line">Get: <span class="number">3</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main ceph amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">11.6</span> MB]</span><br><span class="line">Get: <span class="number">4</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main ceph-test amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">28.2</span> MB]</span><br><span class="line">Get: <span class="number">5</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main radosgw amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">2</span>,<span class="number">576</span> kB]</span><br><span class="line">Get: <span class="number">6</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main ceph-common amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">6</span>,<span class="number">526</span> kB]</span><br><span class="line">Get: <span class="number">7</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main librbd1 amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">2</span>,<span class="number">593</span> kB]</span><br><span class="line">Get: <span class="number">8</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main libradosstriper1 amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">2</span>,<span class="number">554</span> kB]</span><br><span class="line">Get: <span class="number">9</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main librados2 amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">2</span>,<span class="number">479</span> kB]</span><br><span class="line">Get: <span class="number">10</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main python-rados amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">895</span> kB]</span><br><span class="line">Get: <span class="number">11</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main python-cephfs amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">886</span> kB]</span><br><span class="line">Get: <span class="number">12</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main python-rbd amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">891</span> kB]</span><br><span class="line">Get: <span class="number">13</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main ceph-deploy all <span class="number">1.5</span><span class="number">.37</span> [<span class="number">95.9</span> kB]</span><br><span class="line">Get: <span class="number">14</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main ceph-fs-common amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">903</span> kB]</span><br><span class="line">Get: <span class="number">15</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main ceph-fuse amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">2</span>,<span class="number">515</span> kB]</span><br><span class="line">Get: <span class="number">16</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main python-ceph amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">883</span> kB]</span><br><span class="line">Get: <span class="number">17</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main radosgw-agent all <span class="number">1.2</span><span class="number">.7</span> [<span class="number">30.1</span> kB]</span><br><span class="line">Get: <span class="number">18</span> http://mirrors.163.com/ceph/debian-hammer/ jessie/main rbd-fuse amd64 <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> [<span class="number">891</span> kB]</span><br><span class="line">Fetched <span class="number">75.3</span> MB <span class="keyword">in</span> 10s (<span class="number">7</span>,<span class="number">301</span> kB/s)</span><br><span class="line">Reading changelogs... Done</span><br><span class="line">(Reading database <span class="keyword">...</span> <span class="number">74503</span> files and directories currently installed.)</span><br><span class="line">Removing mpt-status (<span class="number">1.2</span><span class="number">.0</span>-<span class="number">8</span>) <span class="keyword">...</span></span><br><span class="line">[ ok ] mpt-statusd is disabled <span class="keyword">in</span> /etc/default/mpt-statusd, not starting..</span><br><span class="line">Removing daemon (<span class="number">0.6</span><span class="number">.4</span>-<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Processing triggers <span class="keyword">for</span> man-db (<span class="number">2.7</span><span class="number">.0</span><span class="number">.2</span>-<span class="number">5</span>) <span class="keyword">...</span></span><br><span class="line">(Reading database <span class="keyword">...</span> <span class="number">74485</span> files and directories currently installed.)</span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/libcephfs1_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking libcephfs1 (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph-mds_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph-mds (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph-test_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph-test (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/radosgw_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking radosgw (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph-common_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph-common (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/librbd1_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking librbd1 (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/libradosstriper1_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking libradosstriper1 (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/librados2_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking librados2 (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/python-rados_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking python-rados (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/python-cephfs_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking python-cephfs (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/python-rbd_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking python-rbd (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph-deploy_1.5.37_all.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph-deploy (<span class="number">1.5</span><span class="number">.37</span>) over (<span class="number">1.5</span><span class="number">.28</span>~bpo70+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph-fs-common_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph-fs-common (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph-fuse_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph-fuse (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/python-ceph_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking python-ceph (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/radosgw-agent_1.2.7_all.deb <span class="keyword">...</span></span><br><span class="line">Unpacking radosgw-agent (<span class="number">1.2</span><span class="number">.7</span>) over (<span class="number">1.2</span><span class="number">.4</span>~bpo70+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/rbd-fuse_0.94.10-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking rbd-fuse (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.5</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Processing triggers <span class="keyword">for</span> man-db (<span class="number">2.7</span><span class="number">.0</span><span class="number">.2</span>-<span class="number">5</span>) <span class="keyword">...</span></span><br><span class="line">Processing triggers <span class="keyword">for</span> systemd (<span class="number">215</span>-<span class="number">17</span>+deb8u2) <span class="keyword">...</span></span><br><span class="line">Setting up libcephfs1 (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up librados2 (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up librbd1 (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up python-rados (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up python-cephfs (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up python-rbd (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up ceph-common (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Installing new version of config file /etc/init.d/rbdmap <span class="keyword">...</span></span><br><span class="line">Setting up ceph (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Installing new version of config file /etc/init.d/ceph <span class="keyword">...</span></span><br><span class="line">Installing new version of config file /etc/init/ceph-osd.conf <span class="keyword">...</span></span><br><span class="line"></span><br><span class="line">Configuration file <span class="string">'/etc/logrotate.d/ceph'</span> </span><br><span class="line"> ==&gt; Modified (by you or by a script) since installation.</span><br><span class="line"> ==&gt; Package distributor has shipped an updated version.</span><br><span class="line">   What would you like to do about it ?  Your options are:</span><br><span class="line">    Y or I  : install the package maintainer<span class="string">'s version</span><br><span class="line">    N or O  : keep your currently-installed version</span><br><span class="line">      D     : show the differences between the versions</span><br><span class="line">      Z     : start a shell to examine the situation</span><br><span class="line"> The default action is to keep your current version.</span><br><span class="line">*** ceph (Y/I/N/O/D/Z) [default=N] ? N</span><br><span class="line">Setting up ceph-mds (0.94.10-1~bpo80+1) ...</span><br><span class="line">Setting up libradosstriper1 (0.94.10-1~bpo80+1) ...</span><br><span class="line">Setting up ceph-test (0.94.10-1~bpo80+1) ...</span><br><span class="line">Setting up radosgw (0.94.10-1~bpo80+1) ...</span><br><span class="line">Installing new version of config file /etc/init.d/radosgw ...</span><br><span class="line">Installing new version of config file /etc/logrotate.d/radosgw ...</span><br><span class="line">Setting up ceph-deploy (1.5.37) ...</span><br><span class="line">Setting up ceph-fs-common (0.94.10-1~bpo80+1) ...</span><br><span class="line">Setting up ceph-fuse (0.94.10-1~bpo80+1) ...</span><br><span class="line">Setting up python-ceph (0.94.10-1~bpo80+1) ...</span><br><span class="line">Setting up radosgw-agent (1.2.7) ...</span><br><span class="line">Installing new version of config file /etc/init.d/radosgw-agent ...</span><br><span class="line">Setting up rbd-fuse (0.94.10-1~bpo80+1) ...</span><br><span class="line">Processing triggers for libc-bin (2.19-18+deb8u1) ...</span><br><span class="line">Processing triggers for systemd (215-17+deb8u2) ...</span><br><span class="line"></span><br><span class="line">Current status: 185 updates [-18].</span></span><br></pre></td></tr></tbody></table>

### 正式升级到最新的hammer

<table><tbody><tr><td class="code"><pre><span class="line">root@demo:/home/demouser# ceph -v </span><br><span class="line">ceph version 0.94.10 (b1e0532418e4631af01acbc0cedd426f1905f4af) #当前软件包版本已经更新</span><br><span class="line">root@demo:/home/demouser# ceph -s </span><br><span class="line"><span class="code">    cluster 23d6f3f9-0b86-432c-bb18-1722f73e93e0</span></span><br><span class="line"><span class="code">     health HEALTH_OK</span></span><br><span class="line"><span class="code">     monmap e1: 1 mons at {ceph.work=10.63.48.19:6789/0}</span></span><br><span class="line"><span class="code">            election epoch 1, quorum 0 ceph.work</span></span><br><span class="line"><span class="code">     osdmap e43: 3 osds: 3 up, 3 in</span></span><br><span class="line"><span class="code">      pgmap v907873: 544 pgs, 16 pools, 2217 kB data, 242 objects</span></span><br><span class="line"><span class="code">            3120 MB used, 88994 MB / 92114 MB avail</span></span><br><span class="line"><span class="code">                 544 active+clean</span></span><br><span class="line"></span><br><span class="line">root@demo:/home/demouser# /etc/init.d/ceph  status</span><br><span class="line"><span class="header">=== mon.ceph.work ===</span></span><br><span class="line">mon.ceph.work: running {"version":"0.94.5"} #mon和osd进程还是跑的旧版本</span><br><span class="line"><span class="header">=== osd.0 ===</span></span><br><span class="line">osd.0: running {"version":"0.94.5"}</span><br><span class="line"><span class="header">=== osd.1 ===</span></span><br><span class="line">osd.1: running {"version":"0.94.5"}</span><br><span class="line"><span class="header">=== osd.2 ===</span></span><br><span class="line">osd.2: running {"version":"0.94.5"}</span><br><span class="line"></span><br><span class="line">root@demo:/home/demouser# /etc/init.d/ceph  restart #手工重启所有服务，线上环境依次先重启mon再是osd，避免批量重启造成影响</span><br><span class="line"><span class="header">=== mon.ceph.work ===</span></span><br><span class="line"><span class="header">=== mon.ceph.work ===</span></span><br><span class="line">Stopping Ceph mon.ceph.work on ceph.work...kill 2267...done</span><br><span class="line"><span class="header">=== mon.ceph.work ===</span></span><br><span class="line">Starting Ceph mon.ceph.work on ceph.work...</span><br><span class="line"><span class="header">=== osd.0 ===</span></span><br><span class="line"><span class="header">=== osd.0 ===</span></span><br><span class="line">Stopping Ceph osd.0 on ceph.work...kill 1082...kill 1082...done</span><br><span class="line"><span class="header">=== osd.0 ===</span></span><br><span class="line">Mounting xfs on ceph.work:/home/ceph/var/lib/osd/ceph-0</span><br><span class="line">create-or-move updated item name <span class="emphasis">'osd.0'</span> weight 0.03 at location {host=ceph.work,root=default} to crush map</span><br><span class="line">Starting Ceph osd.0 on ceph.work...</span><br><span class="line">starting osd.0 at :/0 osd<span class="emphasis">_data /home/ceph/var/lib/osd/ceph-0 /home/ceph/var/lib/osd/ceph-0/journal</span><br><span class="line">=== osd.1 ===</span><br><span class="line">=== osd.1 ===</span><br><span class="line">Stopping Ceph osd.1 on ceph.work...kill 1262...kill 1262...done</span><br><span class="line">=== osd.1 ===</span><br><span class="line">Mounting xfs on ceph.work:/home/ceph/var/lib/osd/ceph-1</span><br><span class="line">create-or-move updated item name 'osd.1' weight 0.03 at location {host=ceph.work,root=default} to crush map</span><br><span class="line">Starting Ceph osd.1 on ceph.work...</span><br><span class="line">starting osd.1 at :/0 osd_</span>data /home/ceph/var/lib/osd/ceph-1 /home/ceph/var/lib/osd/ceph-1/journal</span><br><span class="line"><span class="header">=== osd.2 ===</span></span><br><span class="line"><span class="header">=== osd.2 ===</span></span><br><span class="line">Stopping Ceph osd.2 on ceph.work...kill 1452...kill 1452...done</span><br><span class="line"><span class="header">=== osd.2 ===</span></span><br><span class="line">Mounting xfs on ceph.work:/home/ceph/var/lib/osd/ceph-2</span><br><span class="line">create-or-move updated item name <span class="emphasis">'osd.2'</span> weight 0.03 at location {host=ceph.work,root=default} to crush map</span><br><span class="line">Starting Ceph osd.2 on ceph.work...</span><br><span class="line">starting osd.2 at :/0 osd<span class="emphasis">_data /home/ceph/var/lib/osd/ceph-2 /home/ceph/var/lib/osd/ceph-2/journal</span></span><br></pre></td></tr></tbody></table>

<table><tbody><tr><td class="code"><pre><span class="line">root@demo:/home/demouser# /etc/init.d/ceph  status</span><br><span class="line"><span class="header">=== mon.ceph.work ===</span></span><br><span class="line">mon.ceph.work: running {"version":"0.94.10"} #mon和osd都全部更新到最新</span><br><span class="line"><span class="header">=== osd.0 ===</span></span><br><span class="line">osd.0: running {"version":"0.94.10"}</span><br><span class="line"><span class="header">=== osd.1 ===</span></span><br><span class="line">osd.1: running {"version":"0.94.10"}</span><br><span class="line"><span class="header">=== osd.2 ===</span></span><br><span class="line">osd.2: running {"version":"0.94.10"}</span><br><span class="line">root@demo:/home/demouser# ceph -s</span><br><span class="line"><span class="code">    cluster 23d6f3f9-0b86-432c-bb18-1722f73e93e0</span></span><br><span class="line"><span class="code">     health HEALTH_OK </span></span><br><span class="line"><span class="code">     monmap e1: 1 mons at {ceph.work=10.63.48.19:6789/0}</span></span><br><span class="line"><span class="code">            election epoch 1, quorum 0 ceph.work</span></span><br><span class="line"><span class="code">     osdmap e51: 3 osds: 3 up, 3 in</span></span><br><span class="line"><span class="code">      pgmap v907887: 544 pgs, 16 pools, 2217 kB data, 242 objects</span></span><br><span class="line"><span class="code">            3121 MB used, 88992 MB / 92114 MB avail</span></span><br><span class="line"><span class="code">                 544 active+clean</span></span><br></pre></td></tr></tbody></table>

### 升级到最新jewel版本

<table><tbody><tr><td class="code"><pre><span class="line">root@demo:/home/demouser<span class="comment"># vi /etc/apt/sources.list.d/ceph.list </span></span><br><span class="line">deb http://mirrors.163.com/ceph/debian-jewel/ jessie main <span class="comment">#使用163源更新到最新的jewel</span></span><br><span class="line"></span><br><span class="line">root@demo:/home/demouser<span class="comment"># apt-get update</span></span><br><span class="line"><span class="keyword">...</span></span><br><span class="line">Fetched <span class="number">18.7</span> kB <span class="keyword">in</span> 11s (<span class="number">1</span>,<span class="number">587</span> B/s)</span><br><span class="line">Reading package lists... Done</span><br><span class="line"></span><br><span class="line">root@demo:/home/demouser<span class="comment"># apt-cache policy ceph</span></span><br><span class="line">ceph:</span><br><span class="line">  Installed: <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> <span class="comment">#当前安装的版本</span></span><br><span class="line">  Candidate: <span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> <span class="comment">#准备安装的最新jewel版本</span></span><br><span class="line">  Version table:</span><br><span class="line">     <span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> <span class="number">0</span></span><br><span class="line">        <span class="number">500</span> http://mirrors.163.com/ceph/debian-jewel/ jessie/main amd64 Packages</span><br><span class="line"> *** <span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span> <span class="number">0</span></span><br><span class="line">        <span class="number">100</span> /var/lib/dpkg/status</span><br><span class="line"></span><br><span class="line">root@demo:/home/demouser<span class="comment"># aptitude install ceph ceph-common ceph-deploy ceph-fs-common ceph-fuse ceph-mds libcephfs1 python-ceph python-cephfs  librados2 libradosstriper1 python-rados  radosgw radosgw-agent librbd1 python-rbd rbd-fuse radosgw radosgw-agent</span></span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  ceph-base{a} ceph-mon{a} ceph-osd{a} libboost-random1.55.0{a} libboost-regex1.55.0{a} librgw2{a} xmlstarlet{a}</span><br><span class="line">The following packages will be upgraded:</span><br><span class="line">  ceph ceph-common ceph-fs-common ceph-fuse ceph-mds ceph-test libcephfs1 librados2 libradosstriper1 librbd1 python-ceph python-cephfs python-rados python-rbd radosgw rbd-fuse</span><br><span class="line">The following packages are RECOMMENDED but will NOT be installed:</span><br><span class="line">  btrfs-tools fuse</span><br><span class="line"><span class="number">16</span> packages upgraded, <span class="number">7</span> newly installed, <span class="number">0</span> to remove and <span class="number">184</span> not upgraded.</span><br><span class="line">Need to get <span class="number">169</span> MB of archives. After unpacking <span class="number">464</span> MB will be used.</span><br><span class="line">Do you want to continue? [Y/n/?] y</span><br><span class="line">....</span><br><span class="line">Fetched <span class="number">169</span> MB <span class="keyword">in</span> 15s (<span class="number">11.0</span> MB/s)</span><br><span class="line">Reading changelogs... Done</span><br><span class="line">Selecting previously unselected package libboost-random1.55.0:amd64.</span><br><span class="line">(Reading database <span class="keyword">...</span> <span class="number">74299</span> files and directories currently installed.)</span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/libboost-random1.55.0_1.55.0+dfsg-3_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking libboost-random1.55.0:amd64 (<span class="number">1.55</span><span class="number">.0</span>+dfsg-<span class="number">3</span>) <span class="keyword">...</span></span><br><span class="line">Selecting previously unselected package libboost-regex1.55.0:amd64.</span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/libboost-regex1.55.0_1.55.0+dfsg-3_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking libboost-regex1.55.0:amd64 (<span class="number">1.55</span><span class="number">.0</span>+dfsg-<span class="number">3</span>) <span class="keyword">...</span></span><br><span class="line">Selecting previously unselected package xmlstarlet.</span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/xmlstarlet_1.6.1-1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking xmlstarlet (<span class="number">1.6</span><span class="number">.1</span>-<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/libcephfs1_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking libcephfs1 (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph-mds_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph-mds (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph-test_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph-test (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/radosgw_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking radosgw (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph-common_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph-common (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/librbd1_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking librbd1 (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/libradosstriper1_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking libradosstriper1 (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/librados2_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking librados2 (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Selecting previously unselected package librgw2.</span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/librgw2_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking librgw2 (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/python-rados_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking python-rados (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/python-cephfs_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking python-cephfs (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/python-rbd_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking python-rbd (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Selecting previously unselected package ceph-base.</span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph-base_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph-base (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Selecting previously unselected package ceph-mon.</span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph-mon_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph-mon (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Selecting previously unselected package ceph-osd.</span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph-osd_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph-osd (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph-fs-common_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph-fs-common (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/ceph-fuse_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking ceph-fuse (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/python-ceph_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking python-ceph (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Preparing to unpack <span class="keyword">...</span>/rbd-fuse_10.2.6-<span class="number">1</span>~bpo80+1_amd64.deb <span class="keyword">...</span></span><br><span class="line">Unpacking rbd-fuse (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) over (<span class="number">0.94</span><span class="number">.10</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Processing triggers <span class="keyword">for</span> man-db (<span class="number">2.7</span><span class="number">.0</span><span class="number">.2</span>-<span class="number">5</span>) <span class="keyword">...</span></span><br><span class="line">Processing triggers <span class="keyword">for</span> systemd (<span class="number">215</span>-<span class="number">17</span>+deb8u2) <span class="keyword">...</span></span><br><span class="line">Setting up libboost-random1.55.0:amd64 (<span class="number">1.55</span><span class="number">.0</span>+dfsg-<span class="number">3</span>) <span class="keyword">...</span></span><br><span class="line">Setting up libboost-regex1.55.0:amd64 (<span class="number">1.55</span><span class="number">.0</span>+dfsg-<span class="number">3</span>) <span class="keyword">...</span></span><br><span class="line">Setting up xmlstarlet (<span class="number">1.6</span><span class="number">.1</span>-<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up libcephfs1 (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up librados2 (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up librbd1 (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up libradosstriper1 (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up librgw2 (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up python-rados (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up python-cephfs (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up python-rbd (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up ceph-common (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Installing new version of config file /etc/bash_completion.d/rbd <span class="keyword">...</span></span><br><span class="line">Installing new version of config file /etc/init.d/rbdmap <span class="keyword">...</span></span><br><span class="line">Setting system user ceph properties..usermod: user ceph is currently used by process <span class="number">5312</span></span><br><span class="line">dpkg: error processing package ceph-common (--configure): <span class="comment">#需要重启进程才能更新配置，忽略这里及以下错误</span></span><br><span class="line"> subprocess installed post-installation script returned error exit status <span class="number">8</span></span><br><span class="line">dpkg: dependency problems prevent configuration of ceph-base:</span><br><span class="line"> ceph-base depends on ceph-common (= <span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>); however:</span><br><span class="line">  Package ceph-common is not configured yet.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package ceph-base (--configure):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">dpkg: dependency problems prevent configuration of ceph-mds:</span><br><span class="line"> ceph-mds depends on ceph-base (= <span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>); however:</span><br><span class="line">  Package ceph-base is not configured yet.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package ceph-mds (--configure):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">dpkg: dependency problems prevent configuration of ceph-mon:</span><br><span class="line"> ceph-mon depends on ceph-base (= <span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>); however:</span><br><span class="line">  Package ceph-base is not configured yet.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package ceph-mon (--configure):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">dpkg: dependency problems prevent configuration of ceph-osd:</span><br><span class="line"> ceph-osd depends on ceph-base (= <span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>); however:</span><br><span class="line">  Package ceph-base is not configured yet.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package ceph-osd (--configure):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">dpkg: dependency problems prevent configuration of ceph:</span><br><span class="line"> ceph depends on ceph-mon (= <span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>); however:</span><br><span class="line">  Package ceph-mon is not configured yet.</span><br><span class="line"> ceph depends on ceph-osd (= <span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>); however:</span><br><span class="line">  Package ceph-osd is not configured yet.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package ceph (--configure):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">dpkg: dependency problems prevent configuration of ceph-test:</span><br><span class="line"> ceph-test depends on ceph-common; however:</span><br><span class="line">  Package ceph-common is not configured yet.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package ceph-test (--configure):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">dpkg: dependency problems prevent configuration of radosgw:</span><br><span class="line"> radosgw depends on ceph-common (= <span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>); however:</span><br><span class="line">  Package ceph-common is not configured yet.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package radosgw (--configure):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">Setting up ceph-fs-common (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up ceph-fuse (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up python-ceph (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting up rbd-fuse (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Processing triggers <span class="keyword">for</span> libc-bin (<span class="number">2.19</span>-<span class="number">18</span>+deb8u1) <span class="keyword">...</span></span><br><span class="line">Processing triggers <span class="keyword">for</span> systemd (<span class="number">215</span>-<span class="number">17</span>+deb8u2) <span class="keyword">...</span></span><br><span class="line">Errors were encountered <span class="keyword">while</span> processing:</span><br><span class="line"> ceph-common</span><br><span class="line"> ceph-base</span><br><span class="line"> ceph-mds</span><br><span class="line"> ceph-mon</span><br><span class="line"> ceph-osd</span><br><span class="line"> ceph</span><br><span class="line"> ceph-test</span><br><span class="line"> radosgw</span><br><span class="line">E: Sub-process /usr/bin/dpkg returned an error code (<span class="number">1</span>)</span><br><span class="line">Failed to perform requested operation on package.  Trying to recover:</span><br><span class="line">Setting up ceph-common (<span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>) <span class="keyword">...</span></span><br><span class="line">Setting system user ceph properties..usermod: user ceph is currently used by process <span class="number">5312</span></span><br><span class="line">dpkg: error processing package ceph-common (--configure):</span><br><span class="line"> subprocess installed post-installation script returned error exit status <span class="number">8</span></span><br><span class="line">dpkg: dependency problems prevent configuration of radosgw:</span><br><span class="line"> radosgw depends on ceph-common (= <span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>); however:</span><br><span class="line">  Package ceph-common is not configured yet.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package radosgw (--configure):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">dpkg: dependency problems prevent configuration of ceph-test:</span><br><span class="line"> ceph-test depends on ceph-common; however:</span><br><span class="line">  Package ceph-common is not configured yet.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package ceph-test (--configure):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">dpkg: dependency problems prevent configuration of ceph-base:</span><br><span class="line"> ceph-base depends on ceph-common (= <span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>); however:</span><br><span class="line">  Package ceph-common is not configured yet.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package ceph-base (--configure):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">dpkg: dependency problems prevent configuration of ceph-osd:</span><br><span class="line"> ceph-osd depends on ceph-base (= <span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>); however:</span><br><span class="line">  Package ceph-base is not configured yet.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package ceph-osd (--configure):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">dpkg: dependency problems prevent configuration of ceph-mds:</span><br><span class="line"> ceph-mds depends on ceph-base (= <span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>); however:</span><br><span class="line">  Package ceph-base is not configured yet.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package ceph-mds (--configure):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">dpkg: dependency problems prevent configuration of ceph:</span><br><span class="line"> ceph depends on ceph-osd (= <span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>); however:</span><br><span class="line">  Package ceph-osd is not configured yet.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package ceph (--configure):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">dpkg: dependency problems prevent configuration of ceph-mon:</span><br><span class="line"> ceph-mon depends on ceph-base (= <span class="number">10.2</span><span class="number">.6</span>-<span class="number">1</span>~bpo80+<span class="number">1</span>); however:</span><br><span class="line">  Package ceph-base is not configured yet.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package ceph-mon (--configure):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">Errors were encountered <span class="keyword">while</span> processing:</span><br><span class="line"> ceph-common</span><br><span class="line"> radosgw</span><br><span class="line"> ceph-test</span><br><span class="line"> ceph-base</span><br><span class="line"> ceph-osd</span><br><span class="line"> ceph-mds</span><br><span class="line"> ceph</span><br><span class="line"> ceph-mon</span><br><span class="line"></span><br><span class="line">Current status: <span class="number">184</span> updates [-<span class="number">16</span>].</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@demo:/home/demouser<span class="comment"># /etc/init.d/ceph  status</span></span><br><span class="line">=== mon.ceph.work ===</span><br><span class="line">mon.ceph.work: running {<span class="string">"version"</span>:<span class="string">"0.94.10"</span>} <span class="comment">#当前mon和osd版本还是旧版本</span></span><br><span class="line">=== osd.0 ===</span><br><span class="line">osd.0: running {<span class="string">"version"</span>:<span class="string">"0.94.10"</span>}</span><br><span class="line">=== osd.1 ===</span><br><span class="line">osd.1: running {<span class="string">"version"</span>:<span class="string">"0.94.10"</span>}</span><br><span class="line">=== osd.2 ===</span><br><span class="line">osd.2: running {<span class="string">"version"</span>:<span class="string">"0.94.10"</span>}</span><br><span class="line">root@demo:/home/demouser<span class="comment"># ceph -s</span></span><br><span class="line">    cluster 23d6f3f9-0b86-432c-bb18-1722f73e93e0</span><br><span class="line">     health HEALTH_OK</span><br><span class="line">     monmap e1: <span class="number">1</span> mons at {ceph.work=<span class="number">10.63</span><span class="number">.48</span><span class="number">.19</span>:<span class="number">6789</span>/<span class="number">0</span>}</span><br><span class="line">            election epoch <span class="number">1</span>, quorum <span class="number">0</span> ceph.work</span><br><span class="line">     osdmap e51: <span class="number">3</span> osds: <span class="number">3</span> up, <span class="number">3</span> <span class="keyword">in</span></span><br><span class="line">      pgmap v907893: <span class="number">544</span> pgs, <span class="number">16</span> pools, <span class="number">2217</span> kB data, <span class="number">242</span> objects</span><br><span class="line">            <span class="number">3120</span> MB used, <span class="number">88993</span> MB / <span class="number">92114</span> MB avail</span><br><span class="line">                 <span class="number">544</span> active+clean</span><br><span class="line">root@demo:/home/demouser<span class="comment"># /etc/init.d/ceph restart #手工重启所有服务，线上环境依次先重启mon再是osd，避免批量重启造成影响</span></span><br><span class="line">=== mon.ceph.work ===</span><br><span class="line">=== mon.ceph.work ===</span><br><span class="line">Stopping Ceph mon.ceph.work on ceph.work...kill <span class="number">5312.</span>..done</span><br><span class="line">=== mon.ceph.work ===</span><br><span class="line">Starting Ceph mon.ceph.work on ceph.work...</span><br><span class="line">=== osd.0 ===</span><br><span class="line">=== osd.0 ===</span><br><span class="line">Stopping Ceph osd.0 on ceph.work...kill <span class="number">5677.</span>..kill <span class="number">5677.</span>..done</span><br><span class="line">=== osd.0 ===</span><br><span class="line">Mounting xfs on ceph.work:/home/ceph/var/lib/osd/ceph-<span class="number">0</span></span><br><span class="line">create-or-move updated item name <span class="string">'osd.0'</span> weight <span class="number">0.03</span> at location {host=ceph.work,root=default} to crush map</span><br><span class="line">Starting Ceph osd.0 on ceph.work...</span><br><span class="line">starting osd.0 at :/<span class="number">0</span> osd_data /home/ceph/var/lib/osd/ceph-<span class="number">0</span> /home/ceph/var/lib/osd/ceph-<span class="number">0</span>/journal</span><br><span class="line">=== osd.1 ===</span><br><span class="line">=== osd.1 ===</span><br><span class="line">Stopping Ceph osd.1 on ceph.work...kill <span class="number">6087.</span>..kill <span class="number">6087.</span>..done</span><br><span class="line">=== osd.1 ===</span><br><span class="line">Mounting xfs on ceph.work:/home/ceph/var/lib/osd/ceph-<span class="number">1</span></span><br><span class="line">create-or-move updated item name <span class="string">'osd.1'</span> weight <span class="number">0.03</span> at location {host=ceph.work,root=default} to crush map</span><br><span class="line">Starting Ceph osd.1 on ceph.work...</span><br><span class="line">starting osd.1 at :/<span class="number">0</span> osd_data /home/ceph/var/lib/osd/ceph-<span class="number">1</span> /home/ceph/var/lib/osd/ceph-<span class="number">1</span>/journal</span><br><span class="line">=== osd.2 ===</span><br><span class="line">=== osd.2 ===</span><br><span class="line">Stopping Ceph osd.2 on ceph.work...kill <span class="number">6503.</span>..kill <span class="number">6503.</span>..done</span><br><span class="line">=== osd.2 ===</span><br><span class="line">Mounting xfs on ceph.work:/home/ceph/var/lib/osd/ceph-<span class="number">2</span></span><br><span class="line">create-or-move updated item name <span class="string">'osd.2'</span> weight <span class="number">0.03</span> at location {host=ceph.work,root=default} to crush map</span><br><span class="line">Starting Ceph osd.2 on ceph.work...</span><br><span class="line">starting osd.2 at :/<span class="number">0</span> osd_data /home/ceph/var/lib/osd/ceph-<span class="number">2</span> /home/ceph/var/lib/osd/ceph-<span class="number">2</span>/journal</span><br><span class="line"></span><br><span class="line">root@demo:/home/demouser<span class="comment"># ceph -s #出现crushmap 兼容性告警</span></span><br><span class="line">    cluster 23d6f3f9-0b86-432c-bb18-1722f73e93e0</span><br><span class="line">     health HEALTH_WARN</span><br><span class="line">            crush map has legacy tunables (<span class="keyword">require</span> bobtail, min is firefly) </span><br><span class="line">            all OSDs are running jewel or later but the <span class="string">'require_jewel_osds'</span> osdmap flag is not set</span><br><span class="line">     monmap e1: <span class="number">1</span> mons at {ceph.work=<span class="number">10.63</span><span class="number">.48</span><span class="number">.19</span>:<span class="number">6789</span>/<span class="number">0</span>}</span><br><span class="line">            election epoch <span class="number">2</span>, quorum <span class="number">0</span> ceph.work</span><br><span class="line">     osdmap e61: <span class="number">3</span> osds: <span class="number">3</span> up, <span class="number">3</span> <span class="keyword">in</span></span><br><span class="line">      pgmap v907906: <span class="number">544</span> pgs, <span class="number">16</span> pools, <span class="number">2217</span> kB data, <span class="number">242</span> objects</span><br><span class="line">            <span class="number">3122</span> MB used, <span class="number">88991</span> MB / <span class="number">92114</span> MB avail</span><br><span class="line">                 <span class="number">544</span> active+clean</span><br><span class="line">                 </span><br><span class="line">                 </span><br><span class="line">                 </span><br><span class="line">root@demo:/home/demouser<span class="comment"># /etc/init.d/ceph status #检查所有服务进程版本是否到最新</span></span><br><span class="line">=== mon.ceph.work ===</span><br><span class="line">mon.ceph.work: running {<span class="string">"version"</span>:<span class="string">"10.2.6"</span>} </span><br><span class="line">=== osd.0 ===</span><br><span class="line">osd.0: running {<span class="string">"version"</span>:<span class="string">"10.2.6"</span>}</span><br><span class="line">=== osd.1 ===</span><br><span class="line">osd.1: running {<span class="string">"version"</span>:<span class="string">"10.2.6"</span>}</span><br><span class="line">=== osd.2 ===</span><br><span class="line">osd.2: running {<span class="string">"version"</span>:<span class="string">"10.2.6"</span>}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@demo:/home/demouser<span class="comment"># ceph osd set require_jewel_osds</span></span><br><span class="line">set require_jewel_osds</span><br><span class="line">root@demo:/home/demouser<span class="comment"># ceph osd crush tunables optimal</span></span><br><span class="line">adjusted tunables profile to optimal</span><br><span class="line">root@demo:/home/demouser<span class="comment"># ceph -s #调整crushmap兼容性参数以后恢复正常</span></span><br><span class="line">    cluster 23d6f3f9-0b86-432c-bb18-1722f73e93e0</span><br><span class="line">     health HEALTH_OK</span><br><span class="line">     monmap e1: <span class="number">1</span> mons at {ceph.work=<span class="number">10.63</span><span class="number">.48</span><span class="number">.19</span>:<span class="number">6789</span>/<span class="number">0</span>}</span><br><span class="line">            election epoch <span class="number">2</span>, quorum <span class="number">0</span> ceph.work</span><br><span class="line">     osdmap e63: <span class="number">3</span> osds: <span class="number">3</span> up, <span class="number">3</span> <span class="keyword">in</span></span><br><span class="line">            flags require_jewel_osds</span><br><span class="line">      pgmap v907917: <span class="number">544</span> pgs, <span class="number">16</span> pools, <span class="number">2217</span> kB data, <span class="number">242</span> objects</span><br><span class="line">            <span class="number">3122</span> MB used, <span class="number">88991</span> MB / <span class="number">92114</span> MB avail</span><br><span class="line">                 <span class="number">544</span> active+clean</span><br></pre></td></tr></tbody></table>

## rgw服务的修复

### rgw启动报错

<table><tbody><tr><td class="code"><pre><span class="line">root@demo:/home/demouser<span class="comment"># /etc/init.d/radosgw start #重启失败，发现以下错误log</span></span><br><span class="line"></span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.309461</span> <span class="number">7</span>f7f175998c0  <span class="number">0</span> ceph version <span class="number">10.2</span>.<span class="number">6</span> (<span class="number">656</span>b5b63ed7c43bd014bcafd81b001959d5f089f), process radosgw, pid <span class="number">11488</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.317937</span> <span class="number">7</span>f7f175998c0 <span class="number">20</span> get_system_obj_state: <span class="variable">rctx=</span><span class="number">0</span>x7ffcdb751e30 <span class="variable">obj=</span>.rgw.root:default.realm <span class="variable">state=</span><span class="number">0</span>x7f7f17e93368 s-&gt;<span class="variable">prefetch_data=</span><span class="number">0</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.317943</span> <span class="number">7</span>f7ef17fa700  <span class="number">2</span> RGWDataChangesLog::ChangesRenewThread: start</span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.318759</span> <span class="number">7</span>f7f175998c0 <span class="number">20</span> get_system_obj_state: <span class="variable">rctx=</span><span class="number">0</span>x7ffcdb7518f0 <span class="variable">obj=</span>.rgw.root:converted <span class="variable">state=</span><span class="number">0</span>x7f7f17e93368 s-&gt;<span class="variable">prefetch_data=</span><span class="number">0</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.319140</span> <span class="number">7</span>f7f175998c0 <span class="number">20</span> get_system_obj_state: <span class="variable">rctx=</span><span class="number">0</span>x7ffcdb751060 <span class="variable">obj=</span>.rgw.root:default.realm <span class="variable">state=</span><span class="number">0</span>x7f7f17e94398 s-&gt;<span class="variable">prefetch_data=</span><span class="number">0</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.319513</span> <span class="number">7</span>f7f175998c0 <span class="number">10</span> could not read realm id: (<span class="number">2</span>) No such file <span class="constant">or</span> directory</span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.319858</span> <span class="number">7</span>f7f175998c0 <span class="number">10</span> failed to list objects pool_iterate_begin() returned <span class="variable">r=</span>-<span class="number">2</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.319890</span> <span class="number">7</span>f7f175998c0 <span class="number">20</span> get_system_obj_state: <span class="variable">rctx=</span><span class="number">0</span>x7ffcdb751290 <span class="variable">obj=</span>.cn-zone1.rgw.root:zone_names.default <span class="variable">state=</span><span class="number">0</span>x7f7f17e94e38 s-&gt;<span class="variable">prefetch_data=</span><span class="number">0</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.321308</span> <span class="number">7</span>f7f175998c0  <span class="number">0</span> error <span class="keyword">in</span> read_id for object name: default : (<span class="number">2</span>) No such file <span class="constant">or</span> directory</span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.321335</span> <span class="number">7</span>f7f175998c0 <span class="number">20</span> get_system_obj_state: <span class="variable">rctx=</span><span class="number">0</span>x7ffcdb751290 <span class="variable">obj=</span>.rgw.root:zonegroups_names.default <span class="variable">state=</span><span class="number">0</span>x7f7f17e94e38 s-&gt;<span class="variable">prefetch_data=</span><span class="number">0</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.321725</span> <span class="number">7</span>f7f175998c0  <span class="number">0</span> error <span class="keyword">in</span> read_id for object name: default : (<span class="number">2</span>) No such file <span class="constant">or</span> directory</span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.321756</span> <span class="number">7</span>f7f175998c0 <span class="number">20</span> get_system_obj_state: <span class="variable">rctx=</span><span class="number">0</span>x7ffcdb751f60 <span class="variable">obj=</span>.cn.rgw.root:region_map <span class="variable">state=</span><span class="number">0</span>x7f7f17e93368 s-&gt;<span class="variable">prefetch_data=</span><span class="number">0</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.322998</span> <span class="number">7</span>f7f175998c0 <span class="number">10</span>  cannot find current period zonegroup using local zonegroup</span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.323018</span> <span class="number">7</span>f7f175998c0 <span class="number">20</span> get_system_obj_state: <span class="variable">rctx=</span><span class="number">0</span>x7ffcdb751d10 <span class="variable">obj=</span>.rgw.root:zonegroups_names.cn <span class="variable">state=</span><span class="number">0</span>x7f7f17e93368 s-&gt;<span class="variable">prefetch_data=</span><span class="number">0</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.323356</span> <span class="number">7</span>f7f175998c0  <span class="number">0</span> error <span class="keyword">in</span> read_id for object name: cn : (<span class="number">2</span>) No such file <span class="constant">or</span> directory</span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.323371</span> <span class="number">7</span>f7f175998c0  <span class="number">0</span> failed reading zonegroup info: ret -<span class="number">2</span> (<span class="number">2</span>) No such file <span class="constant">or</span> directory</span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">03</span>:<span class="number">48.324456</span> <span class="number">7</span>f7f175998c0 -<span class="number">1</span> Couldn't init storage provider (RADOS)</span><br></pre></td></tr></tbody></table>

#### 检查最新的pool列表

<table><tbody><tr><td class="code"><pre><span class="line"><span class="literal">root</span>@demo:/<span class="literal">home</span>/demouser<span class="comment"># rados lspools</span></span><br><span class="line">rbd</span><br><span class="line">.cn.rgw.<span class="literal">root</span></span><br><span class="line">.cn-zone1.rgw.<span class="literal">root</span></span><br><span class="line">.cn-zone1.rgw.<span class="built_in">domain</span></span><br><span class="line">.cn-zone1.rgw.<span class="literal">control</span></span><br><span class="line">.cn-zone1.rgw.gc</span><br><span class="line">.cn-zone1.rgw.buckets.index</span><br><span class="line">.cn-zone1.rgw.buckets.extra</span><br><span class="line">.cn-zone1.rgw.buckets</span><br><span class="line">.cn-zone1.log</span><br><span class="line">.cn-zone1.intent-log</span><br><span class="line">.cn-zone1.usage</span><br><span class="line">.cn-zone1.users</span><br><span class="line">.cn-zone1.users.email</span><br><span class="line">.cn-zone1.users.swift</span><br><span class="line">.cn-zone1.users.<span class="literal">uid</span></span><br><span class="line">.rgw.<span class="literal">root</span></span><br><span class="line"><span class="keyword">default</span>.rgw.<span class="literal">control</span> <span class="comment">#新J版本默认新增的几个pool</span></span><br><span class="line"><span class="keyword">default</span>.rgw.data.<span class="literal">root</span></span><br><span class="line"><span class="keyword">default</span>.rgw.gc</span><br><span class="line"><span class="keyword">default</span>.rgw.log</span><br><span class="line"></span><br><span class="line"><span class="literal">root</span>@demo:/<span class="literal">home</span>/demouser<span class="comment"># ceph df</span></span><br><span class="line"><span class="constant">G</span>LOBAL:</span><br><span class="line">    <span class="constant">S</span>IZE       <span class="constant">A</span>VAIL      <span class="constant">R</span>AW <span class="constant">U</span>SED     %<span class="constant">R</span>AW <span class="constant">U</span>SED</span><br><span class="line">    <span class="number">92114</span>M     <span class="number">88987</span>M        <span class="number">3126</span>M          <span class="number">3.39</span></span><br><span class="line"><span class="constant">P</span>OOLS:</span><br><span class="line">    <span class="constant">N</span>AME                            <span class="constant">I</span>D     <span class="constant">U</span>SED      %<span class="constant">U</span>SED     <span class="constant">M</span>AX <span class="constant">A</span>VAIL     <span class="constant">O</span>BJECTS</span><br><span class="line">    rbd                             <span class="number">0</span>          <span class="number">0</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">0</span></span><br><span class="line">    .cn.rgw.<span class="literal">root</span>                    <span class="number">1</span>        <span class="number">338</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">2</span></span><br><span class="line">    .cn-zone1.rgw.<span class="literal">root</span>              <span class="number">2</span>       <span class="number">1419</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">2</span></span><br><span class="line">    .cn-zone1.rgw.<span class="built_in">domain</span>            <span class="number">3</span>       <span class="number">1829</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">9</span></span><br><span class="line">    .cn-zone1.rgw.<span class="literal">control</span>           <span class="number">4</span>          <span class="number">0</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">8</span></span><br><span class="line">    .cn-zone1.rgw.gc                <span class="number">5</span>          <span class="number">0</span>         <span class="number">0</span>        <span class="number">88554</span>M          <span class="number">32</span></span><br><span class="line">    .cn-zone1.rgw.buckets.index     <span class="number">6</span>          <span class="number">0</span>         <span class="number">0</span>        <span class="number">88554</span>M          <span class="number">88</span></span><br><span class="line">    .cn-zone1.rgw.buckets.extra     <span class="number">7</span>          <span class="number">0</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">0</span></span><br><span class="line">    .cn-zone1.rgw.buckets           <span class="number">8</span>      <span class="number">2212</span>k         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">5</span></span><br><span class="line">    .cn-zone1.log                   <span class="number">9</span>          <span class="number">0</span>         <span class="number">0</span>        <span class="number">88554</span>M          <span class="number">80</span></span><br><span class="line">    .cn-zone1.intent-log            <span class="number">10</span>         <span class="number">0</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">0</span></span><br><span class="line">    .cn-zone1.usage                 <span class="number">11</span>         <span class="number">0</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">0</span></span><br><span class="line">    .cn-zone1.users                 <span class="number">12</span>        <span class="number">84</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">7</span></span><br><span class="line">    .cn-zone1.users.email           <span class="number">13</span>         <span class="number">0</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">0</span></span><br><span class="line">    .cn-zone1.users.swift           <span class="number">14</span>         <span class="number">0</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">0</span></span><br><span class="line">    .cn-zone1.users.<span class="literal">uid</span>             <span class="number">15</span>      <span class="number">2054</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">9</span></span><br><span class="line">    .rgw.<span class="literal">root</span>                       <span class="number">16</span>      <span class="number">1588</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">4</span></span><br><span class="line">    <span class="keyword">default</span>.rgw.<span class="literal">control</span>             <span class="number">17</span>         <span class="number">0</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">8</span></span><br><span class="line">    <span class="keyword">default</span>.rgw.data.<span class="literal">root</span>           <span class="number">18</span>         <span class="number">0</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">0</span></span><br><span class="line">    <span class="keyword">default</span>.rgw.gc                  <span class="number">19</span>         <span class="number">0</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">0</span></span><br><span class="line">    <span class="keyword">default</span>.rgw.log                 <span class="number">20</span>         <span class="number">0</span>         <span class="number">0</span>        <span class="number">88554</span>M           <span class="number">0</span></span><br></pre></td></tr></tbody></table>

#### 调整默认的zone配置

<table><tbody><tr><td class="code"><pre><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># rados ls -p .rgw.root #新版本的realm、zone、zonegroup的信息都会默认保存在这里，后续需要将原来region和zone的配置从.cn.rgw.root切换到这里，实现新旧版本的集群数据更新</span></span><br><span class="line">zone_info.<span class="number">2</span>f58efaa-<span class="number">3</span>fa2-<span class="number">48</span>b2-b996-<span class="number">7</span>f924ae1215c</span><br><span class="line">zonegroup_info.<span class="number">9</span>d07fb3c-<span class="number">45</span>d7-<span class="number">4</span>d63-a475-fd6ebd41b722</span><br><span class="line">zonegroups_names.default</span><br><span class="line">zone_names.default</span><br><span class="line"></span><br><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># radosgw-admin realm list #默认realm为空</span></span><br><span class="line">{</span><br><span class="line">    <span class="string">"default_info"</span><span class="symbol">:</span> <span class="string">""</span>,</span><br><span class="line">    <span class="string">"realms"</span><span class="symbol">:</span> []</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># radosgw-admin zonegroups list #默认会新建一个名称为default的zonegroup</span></span><br><span class="line">read_default_id <span class="symbol">:</span> -<span class="number">2</span></span><br><span class="line">{</span><br><span class="line">    <span class="string">"default_info"</span><span class="symbol">:</span> <span class="string">""</span>,</span><br><span class="line">    <span class="string">"zonegroups"</span><span class="symbol">:</span> [</span><br><span class="line">        <span class="string">"default"</span></span><br><span class="line">    ]</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># radosgw-admin zone  list #默认会新建一个名称为default的zone</span></span><br><span class="line">{</span><br><span class="line">    <span class="string">"default_info"</span><span class="symbol">:</span> <span class="string">""</span>,</span><br><span class="line">    <span class="string">"zones"</span><span class="symbol">:</span> [</span><br><span class="line">        <span class="string">"default"</span></span><br><span class="line">    ]</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># radosgw-admin zonegroup get --rgw-zonegroup=default #查看默认的zonegroup配置</span></span><br><span class="line">{</span><br><span class="line">    <span class="string">"id"</span><span class="symbol">:</span> <span class="string">"9d07fb3c-45d7-4d63-a475-fd6ebd41b722"</span>,</span><br><span class="line">    <span class="string">"name"</span><span class="symbol">:</span> <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"api_name"</span><span class="symbol">:</span> <span class="string">""</span>,</span><br><span class="line">    <span class="string">"is_master"</span><span class="symbol">:</span> <span class="string">"true"</span>,</span><br><span class="line">    <span class="string">"endpoints"</span><span class="symbol">:</span> [],</span><br><span class="line">    <span class="string">"hostnames"</span><span class="symbol">:</span> [],</span><br><span class="line">    <span class="string">"hostnames_s3website"</span><span class="symbol">:</span> [],</span><br><span class="line">    <span class="string">"master_zone"</span><span class="symbol">:</span> <span class="string">"2f58efaa-3fa2-48b2-b996-7f924ae1215c"</span>,</span><br><span class="line">    <span class="string">"zones"</span><span class="symbol">:</span> [</span><br><span class="line">        {</span><br><span class="line">            <span class="string">"id"</span><span class="symbol">:</span> <span class="string">"2f58efaa-3fa2-48b2-b996-7f924ae1215c"</span>,</span><br><span class="line">            <span class="string">"name"</span><span class="symbol">:</span> <span class="string">"default"</span>,</span><br><span class="line">            <span class="string">"endpoints"</span><span class="symbol">:</span> [],</span><br><span class="line">            <span class="string">"log_meta"</span><span class="symbol">:</span> <span class="string">"false"</span>,</span><br><span class="line">            <span class="string">"log_data"</span><span class="symbol">:</span> <span class="string">"false"</span>,</span><br><span class="line">            <span class="string">"bucket_index_max_shards"</span><span class="symbol">:</span> <span class="number">0</span>,</span><br><span class="line">            <span class="string">"read_only"</span><span class="symbol">:</span> <span class="string">"false"</span></span><br><span class="line">        }</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"placement_targets"</span><span class="symbol">:</span> [</span><br><span class="line">        {</span><br><span class="line">            <span class="string">"name"</span><span class="symbol">:</span> <span class="string">"default-placement"</span>,</span><br><span class="line">            <span class="string">"tags"</span><span class="symbol">:</span> []</span><br><span class="line">        }</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"default_placement"</span><span class="symbol">:</span> <span class="string">"default-placement"</span>,</span><br><span class="line">    <span class="string">"realm_id"</span><span class="symbol">:</span> <span class="string">""</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># radosgw-admin zone get --rgw-zone=default #查看默认的zone配置</span></span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    <span class="string">"id"</span><span class="symbol">:</span> <span class="string">"2f58efaa-3fa2-48b2-b996-7f924ae1215c"</span>,</span><br><span class="line">    <span class="string">"name"</span><span class="symbol">:</span> <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"domain_root"</span><span class="symbol">:</span> <span class="string">"default.rgw.data.root"</span>,</span><br><span class="line">    <span class="string">"control_pool"</span><span class="symbol">:</span> <span class="string">"default.rgw.control"</span>,</span><br><span class="line">    <span class="string">"gc_pool"</span><span class="symbol">:</span> <span class="string">"default.rgw.gc"</span>,</span><br><span class="line">    <span class="string">"log_pool"</span><span class="symbol">:</span> <span class="string">"default.rgw.log"</span>,</span><br><span class="line">    <span class="string">"intent_log_pool"</span><span class="symbol">:</span> <span class="string">"default.rgw.intent-log"</span>,</span><br><span class="line">    <span class="string">"usage_log_pool"</span><span class="symbol">:</span> <span class="string">"default.rgw.usage"</span>,</span><br><span class="line">    <span class="string">"user_keys_pool"</span><span class="symbol">:</span> <span class="string">"default.rgw.users.keys"</span>,</span><br><span class="line">    <span class="string">"user_email_pool"</span><span class="symbol">:</span> <span class="string">"default.rgw.users.email"</span>,</span><br><span class="line">    <span class="string">"user_swift_pool"</span><span class="symbol">:</span> <span class="string">"default.rgw.users.swift"</span>,</span><br><span class="line">    <span class="string">"user_uid_pool"</span><span class="symbol">:</span> <span class="string">"default.rgw.users.uid"</span>,</span><br><span class="line">    <span class="string">"system_key"</span><span class="symbol">:</span> {</span><br><span class="line">        <span class="string">"access_key"</span><span class="symbol">:</span> <span class="string">""</span>,</span><br><span class="line">        <span class="string">"secret_key"</span><span class="symbol">:</span> <span class="string">""</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"placement_pools"</span><span class="symbol">:</span> [</span><br><span class="line">        {</span><br><span class="line">            <span class="string">"key"</span><span class="symbol">:</span> <span class="string">"default-placement"</span>,</span><br><span class="line">            <span class="string">"val"</span><span class="symbol">:</span> {</span><br><span class="line">                <span class="string">"index_pool"</span><span class="symbol">:</span> <span class="string">"default.rgw.buckets.index"</span>,</span><br><span class="line">                <span class="string">"data_pool"</span><span class="symbol">:</span> <span class="string">"default.rgw.buckets.data"</span>,</span><br><span class="line">                <span class="string">"data_extra_pool"</span><span class="symbol">:</span> <span class="string">"default.rgw.buckets.non-ec"</span>,</span><br><span class="line">                <span class="string">"index_type"</span><span class="symbol">:</span> <span class="number">0</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"metadata_heap"</span><span class="symbol">:</span> <span class="string">""</span>,</span><br><span class="line">    <span class="string">"realm_id"</span><span class="symbol">:</span> <span class="string">""</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<table><tbody><tr><td class="code"><pre><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># radosgw-admin zone get --rgw-zone=default &gt; zone.info#导出默认的zone配置</span></span><br><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># radosgw-admin zone set --rgw-zone=default &lt; zone.info #修改默认配置如下</span></span><br><span class="line">zone id <span class="number">2</span>f58efaa-<span class="number">3</span>fa2-<span class="number">48</span>b2-b996-<span class="number">7</span>f924ae1215c{</span><br><span class="line">    <span class="string">"id"</span><span class="symbol">:</span> <span class="string">"2f58efaa-3fa2-48b2-b996-7f924ae1215c"</span>,</span><br><span class="line">    <span class="string">"name"</span><span class="symbol">:</span> <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"domain_root"</span><span class="symbol">:</span> <span class="string">".cn-zone1.rgw.domain"</span>,</span><br><span class="line">    <span class="string">"control_pool"</span><span class="symbol">:</span> <span class="string">".cn-zone1.rgw.control"</span>,</span><br><span class="line">    <span class="string">"gc_pool"</span><span class="symbol">:</span> <span class="string">".cn-zone1.rgw.gc"</span>,</span><br><span class="line">    <span class="string">"log_pool"</span><span class="symbol">:</span> <span class="string">".cn-zone1.log"</span>,</span><br><span class="line">    <span class="string">"intent_log_pool"</span><span class="symbol">:</span> <span class="string">".cn-zone1.intent-log"</span>,</span><br><span class="line">    <span class="string">"usage_log_pool"</span><span class="symbol">:</span> <span class="string">".cn-zone1.usage"</span>,</span><br><span class="line">    <span class="string">"user_keys_pool"</span><span class="symbol">:</span> <span class="string">".cn-zone1.users"</span>, <span class="comment">#这个是之前的users pool，新版本改名了</span></span><br><span class="line">    <span class="string">"user_email_pool"</span><span class="symbol">:</span> <span class="string">".cn-zone1.users.email"</span>,</span><br><span class="line">    <span class="string">"user_swift_pool"</span><span class="symbol">:</span> <span class="string">".cn-zone1.users.swift"</span>,</span><br><span class="line">    <span class="string">"user_uid_pool"</span><span class="symbol">:</span> <span class="string">".cn-zone1.users.uid"</span>,</span><br><span class="line">    <span class="string">"system_key"</span><span class="symbol">:</span> {</span><br><span class="line">        <span class="string">"access_key"</span><span class="symbol">:</span> <span class="string">""</span>,</span><br><span class="line">        <span class="string">"secret_key"</span><span class="symbol">:</span> <span class="string">""</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"placement_pools"</span><span class="symbol">:</span> [</span><br><span class="line">        {</span><br><span class="line">            <span class="string">"key"</span><span class="symbol">:</span> <span class="string">"default-placement"</span>,</span><br><span class="line">            <span class="string">"val"</span><span class="symbol">:</span> {</span><br><span class="line">                <span class="string">"index_pool"</span><span class="symbol">:</span> <span class="string">".cn-zone1.rgw.buckets.index"</span>,</span><br><span class="line">                <span class="string">"data_pool"</span><span class="symbol">:</span> <span class="string">".cn-zone1.rgw.buckets"</span>,</span><br><span class="line">                <span class="string">"data_extra_pool"</span><span class="symbol">:</span> <span class="string">".cn-zone1.rgw.buckets.extra"</span>,</span><br><span class="line">                <span class="string">"index_type"</span><span class="symbol">:</span> <span class="number">0</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"metadata_heap"</span><span class="symbol">:</span> <span class="string">""</span>,</span><br><span class="line">    <span class="string">"realm_id"</span><span class="symbol">:</span> <span class="string">""</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

#### 调整ceph.conf配置

<table><tbody><tr><td class="code"><pre><span class="line">root@demo:/home/demouser<span class="comment"># /etc/init.d/radosgw start #重启失败，发现以下错误log</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">21</span>:<span class="number">42.300998</span> <span class="number">7</span>fc1d58718c0  <span class="number">0</span> ceph <span class="property">version</span> <span class="number">10.2</span><span class="number">.6</span> (<span class="number">656</span>b5b63ed7c43bd014bcafd81b001959d5f089f), process radosgw, pid <span class="number">12586</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">21</span>:<span class="number">42.318848</span> <span class="number">7</span>fc1d58718c0  <span class="number">0</span> <span class="keyword">error</span> <span class="keyword">in</span> read_id <span class="keyword">for</span> object <span class="property">name</span>: default : (<span class="number">2</span>) No such <span class="type">file</span> <span class="keyword">or</span> directory</span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">21</span>:<span class="number">42.322114</span> <span class="number">7</span>fc1d58718c0  <span class="number">0</span> <span class="keyword">error</span> <span class="keyword">in</span> read_id <span class="keyword">for</span> object <span class="property">name</span>: cn : (<span class="number">2</span>) No such <span class="type">file</span> <span class="keyword">or</span> directory</span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">21</span>:<span class="number">42.322129</span> <span class="number">7</span>fc1d58718c0  <span class="number">0</span> failed reading zonegroup info: ret -<span class="number">2</span> (<span class="number">2</span>) No such <span class="type">file</span> <span class="keyword">or</span> directory</span><br><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">21</span>:<span class="number">42.323295</span> <span class="number">7</span>fc1d58718c0 -<span class="number">1</span> Couldn't init storage provider (RADOS)</span><br></pre></td></tr></tbody></table>

<table><tbody><tr><td class="code"><pre><span class="line">修改ceph.<span class="keyword">conf</span>配置如下</span><br><span class="line">[client.radosgw.<span class="keyword">us</span>-zone1]</span><br><span class="line">     rgw dns name = s3.i.nease.<span class="keyword">net</span></span><br><span class="line">     rgw frontends = fastcgi</span><br><span class="line">     host = ceph.work</span><br><span class="line">     keyring = /etc/ceph/ceph.client.radosgw.keyring</span><br><span class="line">     rgw socket path = /home/ceph/<span class="keyword">var</span>/<span class="keyword">run</span>/ceph-client.radosgw.<span class="keyword">us</span>-zone1.sock</span><br><span class="line">     <span class="keyword">log</span> <span class="keyword">file</span> = /home/ceph/<span class="keyword">log</span>/radosgw.<span class="keyword">us</span>-zone1.<span class="literal">log</span></span><br><span class="line">     rgw <span class="keyword">print</span> <span class="keyword">continue</span> = false</span><br><span class="line">     rgw content length compat = true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@demo:/home/demouser# /etc/init.<span class="keyword">d</span>/radosgw start #成功启动</span><br></pre></td></tr></tbody></table>

#### 测试效果

<table><tbody><tr><td class="code"><pre><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># radosgw-admin metadata list user #user元数据正常</span></span><br><span class="line">[</span><br><span class="line">    <span class="string">"en-user1"</span>,</span><br><span class="line">    <span class="string">"us-zone1"</span>,</span><br><span class="line">    <span class="string">"us-user1"</span>,</span><br><span class="line">    <span class="string">"cn-user1"</span>,</span><br><span class="line">    <span class="string">"en-zone1"</span>,</span><br><span class="line">    <span class="string">"cn-zone1"</span>,</span><br><span class="line">    <span class="string">"cn-user2"</span></span><br><span class="line">]</span><br><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># radosgw-admin metadata list bucket #bucket元数据正常</span></span><br><span class="line">[</span><br><span class="line">    <span class="string">"cn-test1"</span>,</span><br><span class="line">    <span class="string">"us-test1"</span>,</span><br><span class="line">    <span class="string">"en-test1"</span>,</span><br><span class="line">    <span class="string">"cn-test2"</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># radosgw-admin user info --uid=en-user1 #获取用户信息</span></span><br><span class="line">{</span><br><span class="line">    <span class="string">"user_id"</span><span class="symbol">:</span> <span class="string">"en-user1"</span>,</span><br><span class="line">    <span class="string">"display_name"</span><span class="symbol">:</span> <span class="string">"en-user1"</span>,</span><br><span class="line">    <span class="string">"email"</span><span class="symbol">:</span> <span class="string">""</span>,</span><br><span class="line">    <span class="string">"suspended"</span><span class="symbol">:</span> <span class="number">0</span>,</span><br><span class="line">    <span class="string">"max_buckets"</span><span class="symbol">:</span> <span class="number">1000</span>,</span><br><span class="line">    <span class="string">"auid"</span><span class="symbol">:</span> <span class="number">0</span>,</span><br><span class="line">    <span class="string">"subusers"</span><span class="symbol">:</span> [],</span><br><span class="line">    <span class="string">"keys"</span><span class="symbol">:</span> [</span><br><span class="line">        {</span><br><span class="line">            <span class="string">"user"</span><span class="symbol">:</span> <span class="string">"en-user1"</span>,</span><br><span class="line">            <span class="string">"access_key"</span><span class="symbol">:</span> <span class="string">"PWDYNWWXXC3GCYLIJUWL"</span>,</span><br><span class="line">            <span class="string">"secret_key"</span><span class="symbol">:</span> <span class="string">"R5kiJPTEroPkUW9TNNM4WWYgXHSMsHoWPxqkRnsG"</span></span><br><span class="line">        }</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"swift_keys"</span><span class="symbol">:</span> [],</span><br><span class="line">    <span class="string">"caps"</span><span class="symbol">:</span> [],</span><br><span class="line">    <span class="string">"op_mask"</span><span class="symbol">:</span> <span class="string">"read, write, delete"</span>,</span><br><span class="line">    <span class="string">"default_placement"</span><span class="symbol">:</span> <span class="string">""</span>,</span><br><span class="line">    <span class="string">"placement_tags"</span><span class="symbol">:</span> [],</span><br><span class="line">    <span class="string">"bucket_quota"</span><span class="symbol">:</span> {</span><br><span class="line">        <span class="string">"enabled"</span><span class="symbol">:</span> <span class="keyword">false</span>,</span><br><span class="line">        <span class="string">"max_size_kb"</span><span class="symbol">:</span> -<span class="number">1</span>,</span><br><span class="line">        <span class="string">"max_objects"</span><span class="symbol">:</span> -<span class="number">1</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"user_quota"</span><span class="symbol">:</span> {</span><br><span class="line">        <span class="string">"enabled"</span><span class="symbol">:</span> <span class="keyword">false</span>,</span><br><span class="line">        <span class="string">"max_size_kb"</span><span class="symbol">:</span> -<span class="number">1</span>,</span><br><span class="line">        <span class="string">"max_objects"</span><span class="symbol">:</span> -<span class="number">1</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"temp_url_keys"</span><span class="symbol">:</span> []</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">root<span class="variable">@demo</span><span class="symbol">:/home/demouser</span><span class="comment"># radosgw-admin user create --uid=demotest --display-name=demotest #新建用户</span></span><br><span class="line">{</span><br><span class="line">    <span class="string">"user_id"</span><span class="symbol">:</span> <span class="string">"demotest"</span>,</span><br><span class="line">    <span class="string">"display_name"</span><span class="symbol">:</span> <span class="string">"demotest"</span>,</span><br><span class="line">    <span class="string">"email"</span><span class="symbol">:</span> <span class="string">""</span>,</span><br><span class="line">    <span class="string">"suspended"</span><span class="symbol">:</span> <span class="number">0</span>,</span><br><span class="line">    <span class="string">"max_buckets"</span><span class="symbol">:</span> <span class="number">1000</span>,</span><br><span class="line">    <span class="string">"auid"</span><span class="symbol">:</span> <span class="number">0</span>,</span><br><span class="line">    <span class="string">"subusers"</span><span class="symbol">:</span> [],</span><br><span class="line">    <span class="string">"keys"</span><span class="symbol">:</span> [</span><br><span class="line">        {</span><br><span class="line">            <span class="string">"user"</span><span class="symbol">:</span> <span class="string">"demotest"</span>,</span><br><span class="line">            <span class="string">"access_key"</span><span class="symbol">:</span> <span class="string">"1S9Q6K0P90180M1VFPNR"</span>,</span><br><span class="line">            <span class="string">"secret_key"</span><span class="symbol">:</span> <span class="string">"R123LHsqVzMRe3jvJokPPDSYzmAtIxM5jxywQMTP"</span></span><br><span class="line">        }</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"swift_keys"</span><span class="symbol">:</span> [],</span><br><span class="line">    <span class="string">"caps"</span><span class="symbol">:</span> [],</span><br><span class="line">    <span class="string">"op_mask"</span><span class="symbol">:</span> <span class="string">"read, write, delete"</span>,</span><br><span class="line">    <span class="string">"default_placement"</span><span class="symbol">:</span> <span class="string">""</span>,</span><br><span class="line">    <span class="string">"placement_tags"</span><span class="symbol">:</span> [],</span><br><span class="line">    <span class="string">"bucket_quota"</span><span class="symbol">:</span> {</span><br><span class="line">        <span class="string">"enabled"</span><span class="symbol">:</span> <span class="keyword">false</span>,</span><br><span class="line">        <span class="string">"max_size_kb"</span><span class="symbol">:</span> -<span class="number">1</span>,</span><br><span class="line">        <span class="string">"max_objects"</span><span class="symbol">:</span> -<span class="number">1</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"user_quota"</span><span class="symbol">:</span> {</span><br><span class="line">        <span class="string">"enabled"</span><span class="symbol">:</span> <span class="keyword">false</span>,</span><br><span class="line">        <span class="string">"max_size_kb"</span><span class="symbol">:</span> -<span class="number">1</span>,</span><br><span class="line">        <span class="string">"max_objects"</span><span class="symbol">:</span> -<span class="number">1</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"temp_url_keys"</span><span class="symbol">:</span> []</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

## 总结

旧版本hammer的rgw管理模型是 region->zone两级结构，而新版本变成了realm->zonegroup->zone,同时部分pool的命名规则也发生了变更，如果总结升级ceph版本，会出现RGW服务启动失败，导致RGW启动失败的因素有两类，一类是pool名称的变更，另外一类是ceph.conf中rgw的配置变更。本文通过真实用例，实现了新旧版本的切换，各位实际环境还是要谨慎操作，毕竟跨版本的升级还是有很大风险。 —-by 秦牧羊

## 附

官方升级操作指南：[http://docs.ceph.com/docs/master/radosgw/upgrade\_to\_jewel/](http://docs.ceph.com/docs/master/radosgw/upgrade_to_jewel/)

## 变更记录

| Why | Who | When |
| --- | --- | --- |
| 创建 | dev-广州-秦牧羊 | 2017-03-24 |

Source: zphj1987@gmail ([从hammer到jewel的RGW升级实战-by秦牧羊](http://www.zphj1987.com/2017/03/24/from-hammerto-jewel-update-by-qinmuyang/))
